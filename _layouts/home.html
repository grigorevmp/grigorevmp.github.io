<!doctype html>
<html lang="ru">
  {% include head.html %}
  <body class="layout-{{ page.layout }}{% if page.collection %} collection-{{ page.collection }}{% endif %}">
    <a class="skip-link" href="#content">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>

    {% include header.html %}

    <div class="page page--home">
      <main class="main main--home">
        <div class="topbar topbar--home">
          <div class="progress" aria-hidden="true">
            <div class="progress__bar" id="progressBar"></div>
          </div>

          <div class="topbar__row">
             <div class="breadcrumbs">
                <span class="pill">{{ site.title }}</span>
                <span class="sep">/</span>
                <span class="pill pill--muted">Home</span>
            </div>


            <div class="topbar__right">
              <button class="iconbtn" id="toggleTheme" type="button" title="–¢–µ–º–∞">üåó</button>
              <button class="iconbtn" id="backToTop" type="button" title="–ù–∞–≤–µ—Ä—Ö">‚¨ÜÔ∏è</button>
            </div>
          </div>
        </div>

        <article class="content" id="content">
          <header class="hero hero--home">
            <div class="hero__grid">
              <div>
                <h1 class="hero__title">{{ site.title }}</h1>
                {% if page.subtitle %}
                  <p class="hero__subtitle">{{ page.subtitle }}</p>
                {% else %}
                  <p class="hero__subtitle">{{ site.description }}</p>
                {% endif %}

                <div class="hero__cta">
                  <a class="btn btn--primary" href="#feed">üìö –û—Ç–∫—Ä—ã—Ç—å –ª–µ–Ω—Ç—É</a>
                    {% assign start_guide = site.collections['guides'].docs | where: "start", true | first %}
                    {% if start_guide %}
                    <a class="btn btn--ghost" href="{{ start_guide.url | relative_url }}">‚≠ê –ù–∞—á–∞—Ç—å —Å –±–∞–∑–æ–≤–æ–≥–æ</a>
                    {% else %}
                    <a class="btn btn--ghost" href="{{ '/#feed' | relative_url }}">‚≠ê –ù–∞—á–∞—Ç—å —Å –±–∞–∑–æ–≤–æ–≥–æ</a>
                    {% endif %}
                </div>

                <div class="hero__badges">
                  <span class="badge">Kotlin</span>
                  <span class="badge badge--2">Android</span>
                  <span class="badge badge--3">JVM</span>
                  <span class="badge badge--4">CS</span>
                </div>
              </div>

              <div class="stats">
                <div class="stat">
                  <div class="stat__label">–ó–∞–ø–∏—Å–µ–π</div>
                  <div class="stat__value">{{ site.collections['guides'].docs | size }}</div>
                </div>
                <div class="stat">
                  <div class="stat__label">–ö–æ–ª–ª–µ–∫—Ü–∏—è</div>
                  <div class="stat__value">Guides</div>
                </div>
                <div class="stat">
                  <div class="stat__label">–ü–æ–∏—Å–∫</div>
                  <div class="stat__value">Ctrl/‚åò + K</div>
                </div>
              </div>
            </div>
          </header>

          <section class="paper paper--home" id="feed">
            <div class="feedbar">
              <div class="feedbar__left">
                <h2 class="section-title">–ó–∞–ø–∏—Å–∏</h2>
                <div class="muted">start: {{ start_guide.url }}</div>
              </div>

              <div class="feedbar__right">
                <div class="searchbox" role="search">
                    <span class="searchbox__icon" aria-hidden="true">‚åï</span>
                    <input
                        id="homeSearchInput"
                        class="searchbox__input"
                        type="search"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ —Ç–µ–≥–∞–º‚Ä¶"
                        aria-label="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø–∏—Å—è–º"
                        autocomplete="off"
                        spellcheck="false"
                    >
                    <button class="searchbox__clear" id="homeSearchClear" type="button" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">‚úï</button>
                </div>


                <select id="sortSelect" class="select" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
                  <option value="new">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                  <option value="old">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                  <option value="az">A ‚Üí Z</option>
                </select>
              </div>
            </div>

            <div class="tags" id="tagBar">
              <button class="tag is-active" data-tag="__all">–í—Å–µ</button>
            </div>

            <div class="grid" id="guidesGrid">
              {% assign items = site.collections['guides'].docs %}
              {% for p in items %}
                <a class="card"
                  href="{{ p.url | relative_url }}"
                  data-title="{{ p.title | escape }}"
                  data-tags="{{ p.tags | join: ',' | downcase | escape }}"
                  data-order="{% if p.order %}{{ p.order }}{% else %}999999{% endif %}">

                  <div class="card__top">
                    <div class="card__title">{{ p.title }}</div>
                    {% if p.level %}
                      <span class="chip">{{ p.level }}</span>
                    {% endif %}
                  </div>

                  {% if p.description %}
                    <div class="card__desc">{{ p.description }}</div>
                  {% else %}
                    <div class="card__desc">{{ p.subtitle | default: site.description }}</div>
                  {% endif %}

                  <div class="card__meta">
                    <div class="chips">
                      {% if p.tags %}
                        {% for t in p.tags %}
                          <span class="chip chip--tag">{{ t }}</span>
                        {% endfor %}
                      {% else %}
                        <span class="chip chip--tag">guide</span>
                      {% endif %}
                    </div>
                    <div class="card__hint">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</div>
                  </div>

                </a>
              {% endfor %}
            </div>


            <div class="empty" id="emptyState" style="display:none;">
              –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–±—Ä–æ—Å—å —Ñ–∏–ª—å—Ç—Ä—ã.
            </div>
          </section>

          <footer class="content__footer">
            <div class="callout callout--note">
              <div class="callout__title">–ö–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏</div>
              <div class="callout__body">
                –°–æ–∑–¥–∞–π —Ñ–∞–π–ª –≤ <code>guides/</code> —Å front-matter: <code>title</code>, <code>tags</code>, <code>description</code>.
                –û–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –∫–∞—Ä—Ç–æ—á–∫–æ–π.
              </div>
            </div>
          </footer>
        </article>

        {% include footer.html %}
      </main>
    </div>

    <script src="{{ '/assets/js/main.js' | relative_url }}"></script>
    <script>
      // Home-only: tags + filtering + sorting
      (function(){
        const grid = document.getElementById('guidesGrid');
        if(!grid) return;

        const cards = Array.from(grid.querySelectorAll('.card'));
        const tagBar = document.getElementById('tagBar');
        const qInput = document.getElementById('homeSearchInput');
        const sortSelect = document.getElementById('sortSelect');
        const empty = document.getElementById('emptyState');

        const tagsSet = new Set();
        cards.forEach(c => {
          const tags = (c.dataset.tags || '').split(',').map(s => s.trim()).filter(Boolean);
          tags.forEach(t => tagsSet.add(t));
        });

        const allTags = Array.from(tagsSet).sort((a,b)=>a.localeCompare(b,'ru'));
        allTags.forEach(t => {
          const btn = document.createElement('button');
          btn.className = 'tag';
          btn.textContent = t;
          btn.dataset.tag = t;
          tagBar.appendChild(btn);
        });

        let activeTag = '__all';

        function apply(){
          const q = (qInput?.value || '').trim().toLowerCase();
          let visibleCount = 0;

          cards.forEach(c => {
            const title = (c.dataset.title || '').toLowerCase();
            const tags = (c.dataset.tags || '').toLowerCase();

            const okTag = activeTag === '__all' ? true : tags.split(',').includes(activeTag);
            const okQ = !q ? true : (title.includes(q) || tags.includes(q));

            const show = okTag && okQ;
            c.style.display = show ? '' : 'none';
            if(show) visibleCount++;
          });

          empty.style.display = visibleCount ? 'none' : '';
        }

        function sort(){
          const mode = sortSelect.value;
          const sorted = [...cards].sort((a,b)=>{
            if(mode === 'az') return (a.dataset.title||'').localeCompare(b.dataset.title||'', 'ru');
            const oa = Number(a.dataset.order || 999999);
            const ob = Number(b.dataset.order || 999999);
            return mode === 'old' ? oa - ob : ob - oa;
          });
          sorted.forEach(x => grid.appendChild(x));
        }

        tagBar.addEventListener('click', (e)=>{
          const btn = e.target.closest('.tag');
          if(!btn) return;
          tagBar.querySelectorAll('.tag').forEach(x=>x.classList.remove('is-active'));
          btn.classList.add('is-active');
          activeTag = btn.dataset.tag;
          apply();
        });
        const clearBtn = document.getElementById('homeSearchClear');
        function syncClear() {
        if (!clearBtn) return;
        clearBtn.style.opacity = (qInput && qInput.value.trim()) ? '1' : '0';
        clearBtn.style.pointerEvents = (qInput && qInput.value.trim()) ? 'auto' : 'none';
        }
        qInput?.addEventListener('input', () => { apply(); syncClear(); });
        clearBtn?.addEventListener('click', () => {
        if (!qInput) return;
        qInput.value = '';
        qInput.focus();
        apply();
        syncClear();
        });
        syncClear();

        sortSelect?.addEventListener('change', ()=>{ sort(); apply(); });

        sort();
        apply();
      })();
    </script>
  </body>
</html>
